# Contributing to PyWebTransport

Thank you for your interest in contributing to PyWebTransport! This document provides guidelines and information for contributors.

## Code of Conduct

This project adheres to a [Code of Conduct](CODE_OF_CONDUCT.md). By participating, you are expected to uphold this code.

## Our Philosophy

Before contributing, we highly recommend reading our **[Implementation Philosophy](PHILOSOPHY.md)**. It outlines the core principles that guide the project's design and development, ensuring that all contributions align with our long-term goals for standards compliance, a clean architecture, and maintainability.

## Getting Started

### Prerequisites

To contribute to this project, your development environment will need the following tools:

- **Git**: For version control.
- **pyenv**: For managing multiple Python versions. This is crucial for local testing.
- **tox**: For automating tests across all supported Python versions.

We recommend installing `tox` using `pipx` for a clean, isolated installation:

```bash
pipx install tox
```

### Development Setup

1.  **Fork and clone the repository**:
    First, fork the project on GitHub. Then, clone your fork locally:

    ```bash
    git clone https://github.com/lemonsterfy/pywebtransport.git
    cd pywebtransport
    ```

2.  **Set up the Python version**:
    This project requires Python 3.12 or newer. We use a `.python-version` file to recommend a specific version for local development with `pyenv`.

    ```bash
    # pyenv will automatically pick up the version from the .python-version file.
    # You may need to install it first:
    pyenv install $(cat .python-version)
    ```

3.  **Create your primary development environment**:
    Create an isolated virtual environment for the project.

    ```bash
    # Create and activate a virtual environment named .venv
    python -m venv .venv
    source .venv/bin/activate
    ```

4.  **Install development dependencies**:
    To ensure a reproducible environment that matches our CI pipelines, we use a lock file (`dev-requirements.txt`) generated by `pip-tools`. Install all dependencies from this file, then install the project itself in editable mode.

    ```bash
    pip install -r dev-requirements.txt
    pip install -e .
    ```

## Development Workflow

### Making Changes

1.  **Create a feature branch**:
    Create a new branch from `main` for your changes.

    ```bash
    git checkout -b feature/your-feature-name
    ```

2.  **Make your changes**, following the coding standards below.

3.  **Write or update tests** for your changes.

4.  **Run checks and tests**:
    While developing, you can run checks and tests quickly against your primary environment:

    ```bash
    # Run code quality checks
    black src tests
    flake8 src tests
    mypy src tests

    # Run the test suite with pytest
    pytest
    ```

5.  **Run the full test suite with tox**:
    Before submitting your changes, it is **mandatory** to run the full test suite using `tox`. This ensures your changes are compatible with all supported Python versions as defined in `pyproject.toml`.

    ```bash
    tox
    ```

6.  **Commit your changes**:
    Follow the [Conventional Commits](https://www.conventionalcommits.org/en/v1.0.0/) specification for your commit messages.
    ```bash
    git add .
    git commit -m "feat: A brief and descriptive commit message"
    ```

## Coding Standards

### Code Style

We use the following tools to maintain code quality, with configurations located in `pyproject.toml` and `.flake8`:

- **Black**: Code formatting
- **flake8**: Linting and style checking
- **mypy**: Type checking
- **isort**: Import sorting

### Type Hints

- All public functions and methods must include type hints.
- Use modern Python 3.12+ typing syntax. For example:
  - Use `list` instead of `typing.List`
  - Use `X | Y` instead of `typing.Union[X, Y]`
- Use built-in generics (`list`, `dict`) instead of imports from `typing`.

### Documentation

- All public APIs must have docstrings.
- Use a concise, single-line summary for docstrings where appropriate.

Example:

```python
async def create_bidirectional_stream(self) -> WebTransportStream:
    """Create a new bidirectional stream."""
```

### Error Handling

- Use specific exception types from `pywebtransport.exceptions`.
- Include descriptive error messages.
- Properly handle async context managers and resource cleanup.

## Testing

### Test Structure

Tests are organized by type and mirror the source code structure:

```
tests/
├── benchmark/
├── e2e/
├── integration/
└── unit/
```

### Writing Tests

- Write tests for all new functionality.
- Include both positive and negative test cases.
- Test error conditions and edge cases.
- Use pytest fixtures for common setup.

### Running Tests

The primary way to run the full test suite is with `tox`.

For faster, iterative development, you can run `pytest` directly in your activated virtual environment.

## Documentation

### API Documentation

- Document all public APIs with clear and concise docstrings.
- Keep examples up-to-date with API changes.
- Include performance characteristics where relevant.

### Contributing Documentation

When updating documentation:

1.  Update docstrings for code changes.
2.  Update `README.md` if adding major features.
3.  Update architecture documentation for significant changes.

## Pull Request Process

### Before Submitting

1.  **Ensure all checks and tests pass**.
2.  **Update documentation** if needed.

3.  **Add entries to `CHANGELOG.md`** for user-facing changes.

### Submitting a Pull Request

Once your changes are ready, push your branch to your fork and open a pull request against the `main` branch of the original repository. GitHub will automatically use our PR template.

- **Title**: Use a clear, descriptive title following Conventional Commits.
- **Description**: Explain what the PR does and why.
- **Testing**: Describe how the changes were tested.
- **Breaking Changes**: Clearly mark any breaking changes.
- **Links**: Reference related issues.

## Release Process

**(Note: This section is for project maintainers.)**

### Versioning

We follow [Semantic Versioning](https://semver.org/):

- **MAJOR**: Breaking changes
- **MINOR**: New features (backward compatible)
- **PATCH**: Bug fixes (backward compatible)

### Release Steps

1.  Update version in `src/pywebtransport/version.py`.
2.  Update `CHANGELOG.md`.
3.  Create a release pull request to the `main` branch.
4.  After merge, the CI/CD pipeline will automatically tag the release and publish to PyPI.

## Issue Reporting

### Bug Reports

When reporting bugs, please include:

- Python version and operating system
- PyWebTransport version
- Minimal code example reproducing the issue
- Full error traceback
- Expected vs. actual behavior

### Feature Requests

For feature requests:

- Describe the use case and motivation
- Provide examples of the proposed API
- Consider backward compatibility
- Reference relevant WebTransport specifications

## Performance Considerations

When contributing performance-sensitive code:

- Include benchmarks for significant changes (add to `tests/benchmark/`)
- Consider memory allocation patterns
- Test with realistic WebTransport workloads
- Profile critical code paths
- Document performance characteristics

## WebTransport Protocol Compliance

Ensure contributions maintain compliance with the WebTransport protocol suite and its underlying dependencies. Key documents include:

- [WebTransport over HTTP/3 (draft-ietf-webtrans-http3-14)](https://www.ietf.org/archive/id/draft-ietf-webtrans-http3-14.txt)
- [RFC 9114 (HTTP/3)](https://www.rfc-editor.org/rfc/rfc9114.txt)

---

Thank you for contributing to PyWebTransport! Your efforts help advance the WebTransport ecosystem in Python.
